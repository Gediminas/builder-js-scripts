#!/usr/bin/env bash

##################################################
# FUNCTIONS

split_cr () {
  while IFS=$'\r' read -r -n1 ch; do
    if [ -z "$ch" ]; then
      # [[ $ch = "\r*" ]] && echo "" || echo ""
      echo ""
    else
      echo -n "$ch"
    fi
  done
}

tee_time () {
  while read -r line; do
    echo "$line"
    echo -e "$(date '+%Y-%m-%d %H:%M:%S')\t$line" >> "$1"
  done
}

##################################################
# MAIN

echo "BUILD: [START]"

if [ -z "$1" ]; then
    echo "Usage: build some-product"
    exit 1
fi

product=$1
debug=$2
root=$(realpath --no-symlinks "${BASH_SOURCE[0]}")
root=$(dirname "$root")
exe=$(realpath --no-symlinks "$root/recipies/$product.rcpt")

if [ "$debug" == "debug" ]; then
  tmp="$root/_working/$product/_DEBUG"
  rm -fdr "$tmp/_repo"
else
  tmp="$root/_working/$product/$(date '+%Y-%m-%d_%H-%M-%S')"
fi


mkdir -p "$tmp"

echo "BUILD: PROD: $exe"
echo "BUILD: TEMP: $tmp"

mkdir -p "$tmp" && pushd "$_" 1>/dev/null || exit
echo "BUILD: PWD = $PWD"
  echo "----------------------------------------"
  echo "[$(date '+%Y-%m-%d %H:%M:%S')]" |& tee -i 0000.log

  # "$exe" |& split_cr |& tee -ai 0000.log
  # "$exe" |& split_cr |& ts "%Y-%m-%d %H:%M:%S" |& tee -ai 0000.log

  "$exe" |& split_cr |& tee_time 0000.log

  echo "[$(date '+%Y-%m-%d %H:%M:%S')]" |& tee -ai 0000.log
  echo "----------"
popd 1>/dev/null 2>&1

echo "BUILD: [DONE]"
echo "BUILD: Press ENTER to exit..."
#read
