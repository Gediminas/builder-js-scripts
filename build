#!/usr/bin/env bash

DIRNAME="${BASH_SOURCE%[/\\]*}"
readarray -t errors   < "$DIRNAME/cfg/match_errors.txt"
readarray -t warnings < "$DIRNAME/cfg/match_warnings.txt"

for line in "${errors[@]}"; do
	echo "E: $line"
done

for line in "${warnings[@]}"; do
	echo "W: $line"
done

##################################################
# FUNCTIONS

decorate () {

  if [[ $1 =~ (^#\ ) ]]; then
     echo -ne "\e[93m"
     echo -n  "$1"
     echo -e  "\e[0m"
     exit
  fi
  if [[ $1 =~ (^>>\ ) ]]; then
     echo -ne "\e[96m"
     echo -n  "$1"
     echo -e  "\e[0m"
     exit
  fi
  if [[ $1 =~ (^ERROR:\ ) ]]; then
     echo -ne "\e[7;49;91m!!! ERROR: "
     echo -n  "$1"
     echo -e  "\e[0m"
     exit
  fi
  if [[ $1 =~ (^WARNING:\ ) ]]; then
     echo -ne "\e[7;49;93m!!! WARNING: "
     echo -n  "$1"
     echo -e  "\e[0m"
     exit
  fi
  if [[ $1 =~ "fatal error" ]]; then
     echo -ne "\e[7;49;91m!!! ERROR: "
     echo -n  "$1"
     echo -e  "\e[0m"
     exit
  fi
  if [[ $1 =~ (^.{4,10}lite error) ]]; then
     echo -ne "\e[7;49;93m!!! WARNING: "
     echo -n  "$1"
     echo -e  "\e[0m"
     exit
  fi
  echo "$1"
}

teetime () {
  buffer=
  while IFS= read -r -n1 ch; do
    case $ch in
      '')
        buffer=$(decorate "$buffer")
        echo     "$buffer"
        echo -ne  "$(date '+%Y-%m-%d %H:%M:%S')\t" >> "$1"
        echo   "$buffer" >> "$1"
        buffer=
        ;;
      $'\r')
        buffer=$(decorate "$buffer")
        echo -n  "$buffer$ch"
        echo -ne  "$(date '+%Y-%m-%d %H:%M:%S')\t" >> "$1"
        echo   "$buffer" >> "$1"
        buffer=
        ;;
      *)
        buffer=$buffer$ch
        ;;
    esac
  done
}

##################################################
# MAIN

if [ -z "$1" ]; then
    echo "Usage: build some-product"
    exit 1
fi

product=$1
debug=$2
root=$(realpath --no-symlinks "${BASH_SOURCE[0]}")
root=$(dirname "$root")
exe=$(realpath --no-symlinks "$root/recipies/$product.rcpt")

if [ "$debug" == "debug" ]; then
  tmp="$root/_working/$product/_DEBUG"
  rm -fdr "$tmp/_repo"
else
  tmp="$root/_working/$product/$(date '+%Y-%m-%d_%H-%M-%S')"
fi

echo "----------------------------------------"
echo "BUILD: PROD: $exe"
echo "BUILD: TEMP: $tmp"

mkdir -p "$tmp" && pushd "$_" 1>/dev/null || exit
  echo "----------------------------------------"
  "$exe" |& teetime 0000.log
  echo "----------------------------------------"
popd 1>/dev/null 2>&1
